# `Measuring Technologists`

# Общее описание программы

Данная программа представляет собой TCP-сервер, который запускается в качестве службы и предназначен для выполнения задач на больших объемах данных. Она использует библиотеку Dask для эффективной работы с параллельными вычислениями.
  
Сервер принимает задачи в виде набора `Parquet` данных и набора `python` функций для исполнения как объект `Dask`. После получения задачи, сервер выполняет функции на наборе данных из `Parquet` файла при помощи `Dask` библиотеки и возвращает результат клиенту.
# Настройка службы:

Поместите файл `tcp_server.service` в каталог  `*/etc/systemd/system/`

  Перед запуском программы внесите следующие изменения в `tcp_server.service` файл в каталоге  `*/etc/systemd/system/`:
  В секции `[Service]` измените следующие значения:
  
  1)	`User` – Укажите корректное имя пользователя, от которого будет выполнен запуск программы. 
  2)	`WorkingDirectory` – Укажите корректный адрес директории расположения файла server.py.
  3)	`ExecStart` – Укажите полный путь к интерпретатору и полный путь к файлу server.py (через пробел).
  4)	`RestartSec` – Укажите таймаут перезагрузки сервера (в секундах).


# Пример:
    [Unit]
    Description=TCP SERVER
    After=syslog.target
    After=network.target
    
    [Service]
    Type=forking
    User=username
    WorkingDirectory=/username/tcpserver
    ExecStart=/usr/bin/python3 /username/tcpserver/server_v*.py
    RestartSec=10
    Restart=always
    
    [Install]
    WantedBy=multi-user.target

# Запуск:
    sudo systemctl enable tcp_server.service # Добавить службу в автозагрузку ОС
    sudo systemctl start tcp_server.service # Запустить службу
    sudo systemctl status tcp_server.service # Проверить состояние
  
  После перезапуска ОС, запуск программы будет обеспечен средствами ОС.

# Остановка:
    sudo systemctl stop tcp_server.service # Остановить службу
    sudo systemctl disable tcp_server.service # Удалить службу из автозагрузки ОС

# Примеры TCP запросов:

Статус сервера.

    {"Header":"Info",   
    "Request":"Status"} 
Запущено Dask процессов.

    {"Header":"Info",
    "Request":"Dask process"}
Запущено всего процессов.

    {"Header":"Info",
    "Request":"All process"}
Вся статистика.

    {"Header":"Info",
    "Request":"All statistic"}


Dask:

    {"Header":"Dask",
    "Request":{"Directory":"C:/your_folder/",  # Путь к рабочей папке
               "Base":"time_series.parquet",   # Parquet файл с входными данными
               "File":"work.py"}}              # Python файл с формулами
# Описание функций.

`class FileManager` предназначен для выполнения действий с файлами.
| Метод                  | Входные параметры                            | Выходные параметры | Описание                                                                                                                                                                                                                                                                                                                                                                                           |
|------------------------|----------------------------------------------|-------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| __init__(self)          | -                                            | -                 | Конструктор класса.                                                                                                                                                                                                                                                                                                                                                                                 |
| file_name(data: dict)   | data: dict                                   | str               | Метод, который возвращает имя файла без расширения ".py".                                                                                                                                                                                                                                                                                                                                          |
| copy_file(file: str)    | file: str                                    | None              | Метод, который копирует файл в директорию задач и создает копию файла с текущей датой и временем в имени.                                                                                                                                                                                                                                                                                         |
| save_parquet(data, result: any, handler: str) | data: dict, result: any, handler: str | str               | Метод, который сохраняет результат обработки данных в формате Parquet и возвращает имя файла.                                                                                                                                                                                                                                                                                                      |
| save_txt(data: dict, result: any, handler: str) | data: dict, result: any, handler: str | str               | Метод, который сохраняет результат обработки данных в текстовом формате и возвращает имя файла.

`class Loader` наследует функциональность от класса `FileManager` и предназначен для загрузки и выгрузки файлов.

| Метод                 | Входные параметры                       | Выходные параметры | Описание                                                                                                                                      |
|-----------------------|-----------------------------------------|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------------|
| __init__(self)         | -                                       | -                 | Конструктор класса.                                                                                                                           |
| input_file(self, data) | data: dict                              | str               | Метод, который принимает данные в виде словаря и копирует указанный в данных файл в рабочую директорию. Возвращает путь к скопированному файлу. |
| output_file(self, data, result) | data: dict, result: any | str               | Метод, который принимает данные в виде словаря и результат обработки данных, сохраняет результат в файл и возвращает путь к сохраненному файлу. Если возникает ошибка при сохранении в формате Parquet, то сохраняет результат в текстовом формате. |
  
`class Service` предоставляет информацию о текущем состоянии сервера и процессах.
| Метод                 | Входные параметры                       | Выходные параметры | Описание                                                                                                                                      |
|-----------------------|-----------------------------------------|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------------|
| __init__(self)         | -                                       | -                 | Конструктор класса.                                                                                                                           |
| dask_proc(self)        | -                                       | str               | Метод, который возвращает количество запущенных процессов с помощью библиотеки Dask.                                                         |
| all_proc(self)         | -                                       | str               | Метод, который возвращает общее количество запущенных процессов.                                                                             |
| status(self)           | -                                       | str               | Метод, который возвращает текущий статус сервера (готовность или выполнение).                                                               |
| all_stat(self)         | -                                       | str               | Метод, который возвращает информацию о всех запущенных процессах: их статус, количество процессов Dask и общее количество процессов.        |
| info(self, task)       | task: dict                              | str               | Метод, который принимает на вход словарь с заданием и возвращает информацию о запущенных процессах в соответствии с заданием.                 |
  
`class Math` отвечает за выполнение математических операций. Метод `math_work` загружает данные из файла, используя метод `get_file` класса `Loader`, выполняет необходимые операции при помощи библиотеки `Dask` и сохраняет результат в файл при помощи метода `out_file` класса `Loader`.
| Метод                 | Входные параметры                       | Выходные параметры | Описание                                                                                                                                      |
|-----------------------|-----------------------------------------|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------------|
| __init__(self)         | -                                       | -                 | Конструктор класса.                                                                                                                           |
| math_work(self, data)  | data: dict                              | any               | Метод, который принимает на вход словарь с данными, выполняет над ними математические операции и возвращает результат.                     |
  
`class Manager` наследует методы классов `Service` и `Math` и отвечает за управление задачами. Метод `task_manager` обрабатывает запросы клиента и передает их на выполнение в метод `math_work`. 
| Метод                  | Входные параметры                            | Выходные параметры | Описание                                                                                                                                                                                                                                                                                                                                                                                           |
|------------------------|----------------------------------------------|-------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| __init__(self)          | -                                            | -                 | Конструктор класса.                                                                                                                                                                                                                                                                                                                                                                                 |
| task_manager(self, data) | data: dict, ip: list                          | dict              | Метод, который принимает на вход словарь с данными и список IP-адресов узлов, выполняет управление задачами и обработку данных и возвращает результат. Если заголовок данных равен INFO, то метод вызывает метод info() из класса Service. Если заголовок данных равен DASK, то метод добавляет IP-адрес узла в список dask_process и вызывает метод math_work() из класса Math. Возвращает словарь с результатом выполнения операции.     |

`class TCP` предназначен для реализации сетевого взаимодействия по протоколу `TCP`.

| Метод                | Входные параметры                  | Выходные параметры      | Описание                                                                                                                                                    |
|----------------------|----------------------------------|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| __init__(self, host, port) | host: str, port: int          | -                        | Конструктор класса.                                                                                                                 |
| socket_listen(self)  | -                                   | -                        | Создает сокет сервера и начинает слушать входящие соединения.                                                                                                        |
| socket_request(self, client_socket) | client_socket: socket      | (success: bool, request: dict) | Принимает запрос от клиента и возвращает его в виде словаря. В случае ошибки возвращает словарь с описанием ошибки.                                                 |
| socket_response(self, client_socket, data) | client_socket: socket, data: dict      | -                        | Отправляет ответ клиенту в формате JSON. В случае ошибки возвращает словарь с описанием ошибки.                                                                 |


`class Handler` наследует методы классов `Manager` и `TCP` и отвечает за обработку запросов от клиентов. Метод `handle_client` принимает запрос от клиента, передает его на обработку в метод `task_manager` и отправляет ответ клиенту при помощи метода `socket_response`.
| Метод                  | Входные параметры                            | Выходные параметры | Описание                                                                                                                                                                                                                                                                                                                                                                                           |
|------------------------|----------------------------------------------|-------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| __init__(self)          | -                                            | -                 | Конструктор класса.                                                                                                                                                                                                                                                                                                                                                                                 |
| append_process(self, ip) | ip: str                                      | None              | Метод, который добавляет IP-адрес узла в список всех узлов.                                                                                                                                                                                                                                                                                                                                        |
| clear_process(self, ip) | ip: str                                      | None              | Метод, который удаляет IP-адрес узла из списков всех узлов и узлов с запущенным Dask.                                                                                                                                                                                                                                                                                                             |
| handle_client(self, client_socket, ip) | client_socket: socket, ip: str   | None              | Метод, который обрабатывает запрос от клиента через TCP-соединение. Метод добавляет IP-адрес клиента в список всех узлов, вызывает метод task_manager() из класса Manager для обработки запроса и отправляет ответ клиенту через TCP-соединение. После завершения работы с клиентом метод удаляет IP-адрес клиента из списков всех узлов и узлов с запущенным Dask. |
  
`class Server` наследует методы класса `Handler` и представляет собой основной класс программы. Метод `start` запускает сервер и ожидает подключения клиентов.
| Метод                  | Входные параметры                            | Выходные параметры | Описание                                                                                                                                                                                                                                                                                                                                                                                           |
|------------------------|----------------------------------------------|-------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| init(self, host: str, port: int) | host: str, port: int                        | -                 | Конструктор класса.                                                                                                                                                                                                                                                                                                                                                                                 |
| start(self) -> None     | -                                            | -                 | Метод, который запускает сервер и ожидает запросы на обработку данных.                                                                                                                                                                                                                                                                                                                              |
| socket_listen(self) -> Union[Exception, None] | -                         | Union[Exception, None] | Метод, который связывает сервер с IP-адресом и портом и начинает прослушивание входящих запросов.                                                                                                                                                                                                                                                                                               |
| handle_client(self, client_socket, address) -> None | client_socket: socket, address: tuple | -                 | Метод, который обрабатывает запросы на обработку данных от клиентов. |                                                                                                                                                                                                  

# Запуск тестов:
    pytest.exe t_config.py
    pytest.exe t_service.py
    pytest.exe t_math.py

